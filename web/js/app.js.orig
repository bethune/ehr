var DO_SCROLL = true;
var DONT_SCROLL = false;
var DO_AUTO_LOGOUT = true;
var DO_AUTO_SERVER_LOGOUT = true;
var INITIALIZED = false;
var clinician_STATUS_AUTHORIZED = 1;
var clinician_STATUS_NOT_FOUND = 0;
var clinician_STATUS_INVALID_PASSWORD = -1;
var clinician_STATUS_INACTIVE = -2;
var DEFAULT_TABLE_WIDTH = 772;

var clinician = null;
var patients;
var patientChartSummary;
var clinicianDashboard;
var clinicianMessages;
var patientVitalSigns;
var app_templateNames = ['simple_data_table', 'medications_list', 'park', 'patient_search', 'new_user', 'admin', 'update', 
                         'about', 'new_patient', 'new_message', 'chart_summary', 'problem_list', 'new_problem'];
var app_currentPatientId;

$('.dropdown-menu').find('form').click(function (e) {
  e.stopPropagation();
});


/***********      @JQUERY INIT    *******************/
$(document).ready(function() {
  if (INITIALIZED == false) {
    INITIALIZED = true;
    $(function () { $("[data-toggle='popover']").popover({ trigger: "hover" }); });
    app_viewStack('signin-screen', DO_SCROLL);
    RenderUtil.loadTemplates(app_templateNames, function() {
    });
  }
});
/***********      @JQUERY INIT    *******************/
  


function app_viewStack(screen, doScroll) {
  switch (screen) {
    case 'signin-screen':
      $('#app-page-name').html('');
      $('#signin-screen').css({display: "block"});
      $('#dashboard-screen').css({display: "none"});
      $('#patient-chart-screen').css({display: "none"});
      $('#schedule-screen').css({display: "none"});
      $('#messages-screen').css({display: "none"});
      $('#letters-screen').css({display: "none"});
      $('#app-dropdown-logout').css({display: "none"});
      $('#app-dropdown-signin').css({display: "block"});
      $('#main-navigation').css({display: "none"});
    break;
    case 'dashboard-screen':
      $('#app-page-name').html('Dashboard');
      $('#signin-screen').css({display: "none"});
      $('#dashboard-screen').css({display: "block"});
      $('#patient-chart-screen').css({display: "none"});
      $('#schedule-screen').css({display: "none"});
      $('#messages-screen').css({display: "none"});
      $('#letters-screen').css({display: "none"});
      $('#app-dropdown-logout').css({display: "block"});
      $('#app-dropdown-signin').css({display: "none"});
      $('#main-navigation').css({display: "block"});
      getClinicianDashboard();
    break;
    case 'patient-chart-screen':
      $('#app-page-name').html('Patient Chart');
      $('#signin-screen').css({display: "none"});
      $('#dashboard-screen').css({display: "none"});
      $('#patient-chart-screen').css({display: "block"});
      $('#schedule-screen').css({display: "none"});
      $('#messages-screen').css({display: "none"});
      $('#letters-screen').css({display: "none"});
      $('#app-dropdown-logout').css({display: "block"});
      $('#app-dropdown-signin').css({display: "none"});
    break;
    case 'schedule-screen':
      $('#app-page-name').html('Schedule');
      $('#signin-screen').css({display: "none"});
      $('#dashboard-screen').css({display: "none"});
      $('#patient-chart-screen').css({display: "none"});
      $('#schedule-screen').css({display: "block"});
      $('#messages-screen').css({display: "none"});
      $('#letters-screen').css({display: "none"});
      $('#app-dropdown-logout').css({display: "block"});
      $('#app-dropdown-signin').css({display: "none"});
    break;        
    case 'messages-screen':
      $('#app-page-name').html('Messages');
      $('#signin-screen').css({display: "none"});
      $('#dashboard-screen').css({display: "none"});
      $('#patient-chart-screen').css({display: "none"});
      $('#schedule-screen').css({display: "none"});
      $('#messages-screen').css({display: "block"});
      $('#letters-screen').css({display: "none"});
      $('#app-dropdown-logout').css({display: "block"});
      $('#app-dropdown-signin').css({display: "none"});
      $('#messages-view').css({display: "none"});
      $('#messages-inbox').css({display: "block"});
    break;
    case 'letters-screen':
      $('#app-page-name').html('Letters');
      $('#signin-screen').css({display: "none"});
      $('#dashboard-screen').css({display: "none"});
      $('#patient-chart-screen').css({display: "none"});
      $('#schedule-screen').css({display: "none"});
      $('#messages-screen').css({display: "none"});
      $('#letters-screen').css({display: "block"});
      $('#app-dropdown-logout').css({display: "block"});
      $('#app-dropdown-signin').css({display: "none"});
    break;
  }
  if (doScroll) {scroll(0,0);}
}

$('#new-user, #new-user-btn').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('new_user'), {});
  $('#modals-placement').html(s);
  $('#modal-new-user').modal('show'); 
});

$('#admin').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('admin'), {});
  $('#modals-placement').html(s);
  $('#modal-admin').modal('show'); 
});

$('#update').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('update'), {});
  $('#modals-placement').html(s);
  $('#modal-update').modal('show'); 
});

$('#about').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('about'), {});
  $('#modals-placement').html(s);
  $('#modal-about').modal('show'); 
});

$('#mpark, #mspark').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('park'), {});
  $('#modals-placement').html(s);
  $('#modal-park').modal('show'); 
  $('.app-exit').click(function(){ logout(); });
});

$('#new-message').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('new_message'), {});
  $('#modals-placement').html(s);
  $('#modal-new-message').modal('show'); 
});

$('#chart-summary').click(function(){ 
  $('#modal-chart-summary').modal('show'); 
  getPatientChartSummary();
});

$('#problem-list').click(function(){ 
  $('#modal-problem-list').modal('show'); 
});

$('.patient-button-group').click(function(){ 
  var s = RenderUtil.render(RenderUtil.get('patient_search'), {});
  $('#modals-placement').html(s);
  $('#modal-patient-search').modal('show'); 
  $('#btn-patient-search-ok').prop('disabled', true);
  $('#btn-patient-search-ok').addClass('disabled');
  $('.clickable-table-row').removeClass('table-row-highlight');
  $('#btn-patient-search-search').click(function(){ patientSearch(); });
  $('#btn-patient-search-ok').click(function(){ getPatientChart(); });
  
  $('#btn-patient-search-new-patient').click(function() { 
    var s = RenderUtil.render(RenderUtil.get('new_patient'), {});
    $('#modals-placement').append(s);
    $('#modal-new-patient').modal('show');
    $('#new-patient-save, #new-patient-cancel').click(function(){ $('#modal-new-patient').modal('hide'); });
    $('#modal-new-patient').on('hidden.bs.modal', function () { debug("new-patient modal hidden"); });
    $('#modal-new-patient').on('hide.bs.modal', function () { debug("new-patient hide called"); });
  });
    
 $('#modal-patient-search').on('hidden.bs.modal', function () { debug("patient-search modal hidden"); });
 $('#modal-patient-search').on('hide.bs.modal', function () { debug("patient-search hide called"); });
 
});
        
$('#app-signin-submit').click(function(){ login(); });
$('.app-exit').click(function(){ logout(); });

$('.app-dashboard-link').click(function(){ viewDashboard(); });
$('.app-messages-link').click(function(){ viewMessages(); });
$('.app-letters-link').click(function(){ viewLetters(); });
$('.app-schedule-link').click(function(){ viewSchedule(); });
$('#message-view-button').click(function(){ viewClinicianMessage(); });

function viewMessages() {
  app_viewStack('messages-screen', DO_SCROLL);
  getClinicianMessages();
}

function viewLetters() {
  app_viewStack('letters-screen', DO_SCROLL);
}

function viewSchedule() {
  app_viewStack('schedule-screen', DO_SCROLL);
  app_loadCalendar();
}


function getClinicianMessages() {
  var jsonData = JSON.stringify({ id: clinician.id, sessionId: clinician.sessionId });
  $.post("app/getClinicianMessages", {data:jsonData}, function(data) {
    var parsedData = $.parseJSON(data);
    clinicianMessages = parsedData.patientMessages;
    var s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
     {items:clinicianMessages, 
      title:'Messages', 
      clickable:true, 
      columns:[
        {title:'Date', field:'date', type:'date'},
        {title:'From', field:'patient.firstName', type:'clinician'},
        {title:'Subject', field:'subject', type:'simple'}
      ]}
    );
    $('#messages-inbox').html(s);
    $('.clickable-table-row').click( function(e){ 
      $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
      //handleClickableRow(e); 
    });
  });
}

function viewClinicianMessage() {
  $('#messages-view').css({display: "block"});
  $('#messages-inbox').css({display: "none"});
}



function patientSearch() {
  var jsonData = JSON.stringify({ id: clinician.id, sessionId: clinician.sessionId });
  $.post("app/patientSearch", {data:jsonData}, function(data) {
    var parsedData = $.parseJSON(data);
    patients = parsedData.patients;
    var s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
     {items:patients, 
      title:'Patients', 
      clickable:true, 
      columns:[
        {title:'Full Name', field:'fullName', type:'simple'},
        {title:'Date of Birth', field:'dob', type:'date'},
        {title:'Gender', field:'gender.name', type:'name'},
        {title:'Street Address', field:'streetAddress1', type:'streetAddress'},
        {title:'City', field:'city', type:'simple'},
        {title:'State', field:'usState.name', type:'name'}
      ]}
    );
    $('#patient-search-results').html(s);
    $('.clickable-table-row').click( function(e){ 
      $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
      handleClickableRow(e); 
    });
  });
}


  function handleClickableRow(e) {
    var id = undefined;
    var tableId = undefined;
    var attributes = e.currentTarget.attributes;
    for (i=0;i<attributes.length;i++) {
      if (attributes[i].name == 'name') {
        id = attributes[i].nodeValue; 
      }
      if (attributes[i].name == 'id') {
        tableId = attributes[i].nodeValue; 
      }
    }
    
    if (id !== undefined) {
      app_currentPatientId = id; 
      $('#btn-patient-search-ok').prop('disabled', false);
      $('#btn-patient-search-ok').removeClass('disabled');
    }
  }
  
function getClinicianDashboard() {
    var jsonData = JSON.stringify({ id: clinician.id, sessionId: clinician.sessionId });
    $.post("app/getClinicianDashboard", {data:jsonData}, function(data) {
      var parsedData = $.parseJSON(data);
      clinicianDashboard = parsedData.dashboard;
      
      var s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:clinicianDashboard.messages, 
        title:'Messages', 
        clickable:true, 
        columns:[
          {title:'Date', field:'date', type:'date'}, 
          {title:'From', field:'patient.firstName', type:'clinician'}, 
          {title:'Subject', field:'subject', type:'simple'}
        ]}
      );
      $('#clinician-dashboard-messages').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:clinicianDashboard.progressNotes, 
        title:'Progress Notes', 
        clickable:true, 
        columns:[
          {title:'Date', field:'date', type:'date'}, 
          {title:'Patient', field:'patient.firstName', type:'clinician'}, 
          {title:'Subject', field:'subject', type:'simple'}
        ]}
      );
      $('#clinician-dashboard-progress-notes').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
     
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:clinicianDashboard.toDoNotes, 
        title:'To Do', 
        clickable:true, 
        columns:[
          {title:'Date', field:'date', type:'date'}, 
          {title:'Patient', field:'patient.firstName', type:'clinician'}, 
          {title:'Subject', field:'subject', type:'simple'}
        ]}
      );
      $('#clinician-dashboard-to-do-notes').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:clinicianDashboard.labReview, 
        title:'Lab Review', 
        clickable:true, 
        columns:[
          {title:'Date', field:'date', type:'date'}, 
          {title:'Patient', field:'patient.firstName', type:'clinician'}, 
          {title:'Lab', field:'name', type:'simple'},
          {title:'Value', field:'value', type:'simple'}
        ]}
      );
      $('#clinician-dashboard-lab-review').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:clinicianDashboard.clinicianSchedule, 
        title:'Schedule', 
        clickable:true, 
        columns:[
          {title:'Time', field:'date', type:'date'}, 
          {title:'Length', field:'length', type:'simple'},
          {title:'Age', field:'age', type:'simple'},
          {title:'Gender', field:'gender.name', type:'name'}, 
          {title:'Patient', field:'patient.firstName', type:'clinician'}, 
          {title:'Reason', field:'reason', type:'simple'},
          {title:'Comments', field:'comments', type:'simple'},
          {title:'Status', field:'status', type:'simple'},
          {title:'Patient Location', field:'patientLocation', type:'simple'},
          {title:'Room', field:'room', type:'simple'},
          {title:'Checked In', field:'checkedIn', type:'simple'},
          {title:'Wait Time', field:'waitTime', type:'simple'},
          {title:'Progress Note Status', field:'progressNoteStatus', type:'simple'}
        ]}
      );
      $('#clinician-dashboard-schedule').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });


    });
  }
  
  
  function getPatientChart() {
    var jsonData = JSON.stringify({ id: app_currentPatientId, sessionId: clinician.sessionId });
    var s = RenderUtil.render(RenderUtil.get('chart_summary'), {});
    $('#modals-placement').append(s);
    s = RenderUtil.render(RenderUtil.get('problem_list'), {});
    $('#modals-placement').append(s);
    $.post("app/getPatientChart", {data:jsonData}, function(data) {
      var parsedData = $.parseJSON(data);
      var fullName = util_buildFullName(parsedData.firstName, parsedData.middleName, parsedData.lastName);
      $('.patient-chart-full-name').html(fullName);
      $('.patient-chart-dob').html(dateFormat(parsedData.dob, 'mm/dd/yyyy'));
      $('.patient-chart-gender').html(parsedData.gender.name);
      $('.patient-chart-mrn').html(parsedData.mrn);
      $('.patient-chart-primary-phone').html(parsedData.primaryPhone);
      $('.patient-chart-secondary-phone').html(parsedData.secondaryPhone);
      $('.headshot').attr('src', 'files/patients/'+parsedData.id+'/'+parsedData.profileImagePath);
      viewPatientChart();
    });
  }
  
  function getPatientChartSummary() {
    var jsonData = JSON.stringify({ id: app_currentPatientId, clinicianId: clinician.id, sessionId: clinician.sessionId });
    $.post("app/getPatientChartSummary", {data:jsonData}, function(data) {
      var parsedData = $.parseJSON(data);
      patientChartSummary = parsedData.patientChartSummary;
      
      var s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientEncounters, 
        title:'Visits', 
        clickable:true, 
        columns:[
          {title:'Date', field:'date', type:'date'},
          {title:'Title', field:'title', type:'simple'}
        ]}
      );
      $('#patient-chart-summary-visits').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientVitalSigns, 
        title:'Vital Signs', 
        clickable:true, 
        columns:[
          {title:'Height', field:'height', type:'simple'},
          {title:'Weight', field:'weight', type:'simple'},
          {title:'BMI', field:'bmi', type:'simple'},
          {title:'OFC', field:'ofc', type:'simple'},
          {title:'Temp', field:'temperature', type:'simple'},
          {title:'Pulse', field:'pulse', type:'simple'},
          {title:'Resp', field:'respiration', type:'simple'},
          {title:'Syst', field:'systolic', type:'simple'},
          {title:'Dia', field:'diastolic', type:'simple'},
          {title:'Ox', field:'oximetry', type:'simple'}
        ]}
      );
      $('#patient-chart-summary-vital-signs').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientHealthIssues, 
        title:'Health Maintenance', 
        clickable:true, 
        columns:[
         {title:'Health Issue', field:'healthIssue.name', type:'name'}, 
         {title:'Date', field:'date', type:'date'}
        ]}
      );
      $('#patient-chart-summary-hm').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
     
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientAllergens, 
        title:'Allergens', 
        clickable:true, 
        columns:[
          {title:'Allergen', field:'allergen.name', type:'name'}, 
          {title:'Reaction', field:'comment', type:'simple'}
        ]}
      );
      $('#patient-chart-summary-allergens').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
      s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientMedications, 
        title:'Medication', 
        clickable:true, 
        columns:[
          {title:'Medication', field:'medication.name', type:'name'}, 
          {title:'Date', field:'date', type:'date'},
          {title:'Unit', field:'unit', type:'simple'},
          {title:'Instructions', field:'instructions', type:'simple'}
        ]}
      );
      $('#patient-chart-summary-medication').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      
       s = RenderUtil.render(RenderUtil.get('simple_data_table'), 
       {items:patientChartSummary.patientMedicalProcedures, 
        title:'Procedures', 
        clickable:true, 
        columns:[
          {title:'Procedure', field:'medicalProcedure.name', type:'name'}, 
          {title:'Due Date', field:'date', type:'date'},
          {title:'Status', field:'status.name', type:'name'},
          {title:'Last Done', field:'date', type:'date'}
        ]}
      );
      $('#patient-chart-summary-procedures').html(s);
      $('.clickable-table-row').click( function(e){ 
        $(this).addClass('table-row-highlight').siblings().removeClass('table-row-highlight');
        //handleClickableRow(e); 
      });
      

    });
  }
  


  function getColumnValue(column, item) {
    var value = '';
    
    if (column.type == 'simple') {
      value = item[column.field];
    }
    else if (column.type == 'date') {
      value = dateFormat(item[column.field], 'mm/dd/yyyy')
    }
    else if (column.type == 'date-time') {
      value = dateFormat(item[column.field], 'mm/dd/yyyy hh:mm')
    }
    else {
      var columnFields = column.field.split('.'); 
      var columnField = columnFields[0];
      var columnFieldName = columnFields[1];

      if (column.type == 'name') {
        value = item[columnField][columnFieldName];
      }
      else if (column.type == 'clinician') {
        value = util_buildFullName(item[columnField]['firstName'], item[columnField]['middleName'], item[columnField]['lastName'])
      }
      else if (column.type == 'description') {
        value = item['appointmentType']['name'] + " with " + util_buildFullName(item[columnField]['firstName'], item[columnField]['middleName'], item[columnField]['lastName'])
      }
      else if (column.type == 'streetAddress') {
        value = util_nullCheck(item['streetAddress1']) + " " + util_nullCheck(item['streetAddress2']);
      }
    }
    return value;
  }

function viewPatientChart() {
  app_viewStack('patient-chart-screen', DO_SCROLL);
}

function viewDashboard() {
  app_viewStack('dashboard-screen', DO_SCROLL);
}

function login() {
   if($.trim($("#app-signin-username").attr("value")).length < 1 || $.trim($("#app-signin-password").attr("value")).length < 1) { 
      return;
    }
    $('#app-login-running').css({display: "block"});
    var jsonData = JSON.stringify({ username: $('#app-signin-username').attr("value"), password: $('#app-signin-password').attr("value")});
    $.post("app/login", {data:jsonData},
      function(data) {
        $('#app-login-error').css({display:'none'});
        var parsedData = $.parseJSON(data);
        clinician = new Clinician();
        clinician.id = parsedData.id;
        clinician.firstName = parsedData.firstName;
        clinician.middleName = parsedData.middleName;
        clinician.lastName = parsedData.lastName;
        clinician.streetAddress1 = parsedData.streetAddress1;
        clinician.streetAddress2 = parsedData.streetAddress2;
        clinician.city = parsedData.city;
        clinician.state = parsedData.state;
        clinician.zip = parsedData.zip;
        clinician.primaryPhone = parsedData.primaryPhone;
        clinician.secondaryPhone = parsedData.secondaryPhone;
        clinician.email = parsedData.email;
        clinician.authStatus = parsedData.authStatus;
        clinician.patientId = parsedData.patientId;
        clinician.previousLoginTime = parsedData.previousLoginTime;
        clinician.sessionId = parsedData.sessionId;
        
        $('#app-login-running').css({display: "none"});
        
        if (clinician.authStatus == clinician_STATUS_AUTHORIZED) {
          clinicianFullName = util_buildFullName(clinician.firstName, clinician.middleName, clinician.lastName);
          notificationText = clinicianFullName + ' logged in.';
          app_viewStack('dashboard-screen', DO_SCROLL); 
        }  
        else  {
          if (clinician.authStatus == clinician_STATUS_NOT_FOUND) {
            notificationText = 'Clinician not found in system';
          }
          else if (clinician.authStatus == clinician_STATUS_INVALID_PASSWORD) {
            notificationText = 'Invalid password';
          }
          else if (clinician.authStatus == clinician_STATUS_INACTIVE) {
            notificationText = 'Clinician is inactive';
          }
        }
        displayNotification(notificationText);
      }
    );  
}




function logout() {
  if (clinician == null) {
    return;
  }
  var jsonData = JSON.stringify({ sessionId: clinician.sessionId });
  $.post("app/logout", {data:jsonData}, function(data) {
    var parsedData = $.parseJSON(data);
    app_viewStack('signin-screen', DO_SCROLL);
    clinicianFullName = util_buildFullName(clinician.firstName, clinician.middleName, clinician.lastName);
    notificationText = clinicianFullName + ' logged out.';
    displayNotification(notificationText);
    clinician = null;
  });
}

function displayNotification(text) {
  $('#wdm-notification-text').html(text);
  $('#wdm-notification').fadeIn(400).delay(3000).fadeOut(400); 
}